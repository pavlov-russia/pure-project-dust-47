import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";

const Header = () => {
  const [showCTA, setShowCTA] = useState(false);

  const handleCTAClick = () => {
    // Находим форму консультации и скроллим к ней
    const consultationForm = document.querySelector('[data-consultation-form]');
    if (consultationForm) {
      consultationForm.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
  };

  useEffect(() => {
    const rootEl = document.getElementById('root');
    const heroEl = document.querySelector('[data-hero]');

    if (!rootEl) return;

    // Если есть Hero — используем IntersectionObserver относительно #root
    if (heroEl && 'IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          const entry = entries[0];
          // Показываем кнопку, когда Hero почти вышел из области (видимость < 20%)
          setShowCTA(entry.intersectionRatio < 0.2);
        },
        {
          root: rootEl,
          threshold: [0, 0.2, 0.5, 1],
        }
      );

      observer.observe(heroEl);

      return () => observer.disconnect();
    }

    // Fallback: слушаем скролл у #root
    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          const scrollTop = rootEl.scrollTop;
          setShowCTA(scrollTop > 400);
          ticking = false;
        });
        ticking = true;
      }
    };

    rootEl.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => rootEl.removeEventListener('scroll', handleScroll);
  }, []);

  return (
    <>
    <header className="fixed top-0 left-0 right-0 z-50 animate-fade-in">
      {/* Advanced Glassmorphism Container with SVG-inspired styling */}
      <div 
        className="relative overflow-hidden rounded-[24px] border-0"
        style={{
          backdropFilter: 'blur(40px)',
          WebkitBackdropFilter: 'blur(40px)',
          backgroundColor: 'rgba(255, 255, 255, 0.07)',
          mixBlendMode: 'screen',
          border: '1px solid rgba(255, 255, 255, 0.08)',
        }}
      >
        <div className="container mx-auto px-3 md:px-6 pt-[84px] md:pt-[120px] pb-[3px] md:pb-[3px] flex items-center justify-center relative max-w-full mt-3 md:mt-4">
        {/* Logo - центрированный */}
        <div className="flex items-center relative z-10">
          <svg width="120" height="24" viewBox="0 0 257 51" fill="none" xmlns="http://www.w3.org/2000/svg" className="h-6 md:h-8 w-auto drop-shadow-sm">
            <path fillRule="evenodd" clipRule="evenodd" d="M0 2.38041C0 1.06574 1.06574 0 2.3804 0H8.8075C10.1222 0 11.1879 1.06574 11.1879 2.3804V8.33142C11.1879 9.64608 12.2536 10.7118 13.5683 10.7118H19.2813C20.5959 10.7118 21.6617 11.7776 21.6617 13.0922V19.0432C21.6617 20.3579 20.5959 21.4236 19.2813 21.4236H13.5683C12.2536 21.4236 11.1879 22.4894 11.1879 23.8041V29.7551C11.1879 31.0697 12.2536 32.1355 13.5683 32.1355H19.2813C20.5959 32.1355 21.6617 33.2012 21.6617 34.5159V40.4669C21.6617 41.7816 20.5959 42.8473 19.2813 42.8473H12.8542C11.5395 42.8473 10.4738 41.7816 10.4738 40.4669V34.5159C10.4738 33.2012 9.40804 32.1355 8.09338 32.1355H2.38041C1.06574 32.1355 0 31.0697 0 29.7551V2.38041Z" fill="currentColor" className="text-primary"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M34.9924 2.38041C34.9924 1.06574 33.9267 0 32.612 0H28.0893C26.7746 0 25.7089 1.06574 25.7089 2.38041V40.4669C25.7089 41.7816 26.7746 42.8473 28.0893 42.8473H34.9924H43.7999C45.1146 42.8473 46.1803 41.7816 46.1803 40.4669V34.5159C46.1803 33.2012 47.2461 32.1355 48.5608 32.1355H54.0357C55.3503 32.1355 56.4161 31.0697 56.4161 29.7551V23.8041C56.4161 22.4894 55.3503 21.4236 54.0357 21.4236H48.5608C47.2461 21.4236 46.1803 20.3579 46.1803 19.0432V13.0922C46.1803 11.7776 45.1146 10.7118 43.7999 10.7118H37.3728C36.0582 10.7118 34.9924 9.64608 34.9924 8.33142V2.38041ZM45.2282 23.8041C45.2282 22.4894 44.1624 21.4236 42.8478 21.4236H37.3728C36.0582 21.4236 34.9924 22.4894 34.9924 23.8041V29.7551C34.9924 31.0697 36.0582 32.1355 37.3728 32.1355H42.8478C44.1624 32.1355 45.2282 31.0697 45.2282 29.7551V23.8041Z" fill="currentColor" className="text-primary"/>
            <path d="M236.829 32.7608C238.427 34.3241 240.494 35.1058 243.03 35.1058C245.566 35.1058 247.634 34.3241 249.232 32.7608C250.83 31.2322 251.629 29.2346 251.629 26.7679C251.629 24.3013 250.83 22.3037 249.232 20.7751C247.634 19.2118 245.566 18.4301 243.03 18.4301C240.494 18.4301 238.427 19.2118 236.829 20.7751C235.231 22.3037 234.432 24.3013 234.432 26.7679C234.432 29.2346 235.231 31.2322 236.829 32.7608ZM256.84 14.0006V39.0142C256.84 42.6272 255.589 45.5281 253.088 47.7168C250.621 49.9055 247.356 50.9998 243.291 50.9998C239.365 50.9998 236.152 49.975 233.65 47.9253C231.184 45.9103 229.881 43.2873 229.742 40.0564H235.005C235.144 41.8629 235.943 43.3047 237.402 44.3817C238.931 45.4934 240.894 46.0492 243.291 46.0492C245.827 46.0492 247.859 45.4239 249.388 44.1732C250.882 42.8878 251.629 41.1681 251.629 39.0142V36.148C249.127 38.7536 246.001 40.0564 242.249 40.0564C238.531 40.0564 235.439 38.7884 232.973 36.2523C230.472 33.7162 229.221 30.5547 229.221 26.7679C229.221 22.9812 230.472 19.8197 232.973 17.2836C235.439 14.7475 238.531 13.4795 242.249 13.4795C246.001 13.4795 249.127 14.7823 251.629 17.3879V14.0006H256.84Z" fill="currentColor" className="text-foreground"/>
            <path d="M205.786 33.1256C207.384 34.7236 209.417 35.5227 211.883 35.5227C214.35 35.5227 216.382 34.7236 217.98 33.1256C219.578 31.5275 220.378 29.4951 220.378 27.0285C220.378 24.5619 219.578 22.5295 217.98 20.9315C216.382 19.3334 214.35 18.5343 211.883 18.5343C209.417 18.5343 207.384 19.3334 205.786 20.9315C204.188 22.5295 203.389 24.5619 203.389 27.0285C203.389 29.4951 204.188 31.5275 205.786 33.1256ZM202.086 17.3358C204.657 14.7649 207.923 13.4795 211.883 13.4795C215.844 13.4795 219.109 14.7649 221.68 17.3358C224.286 19.8718 225.589 23.1028 225.589 27.0285C225.589 30.9542 224.286 34.1852 221.68 36.7213C219.109 39.2921 215.844 40.5775 211.883 40.5775C207.923 40.5775 204.657 39.2921 202.086 36.7213C199.481 34.1852 198.178 30.9542 198.178 27.0285C198.178 23.1028 199.481 19.8718 202.086 17.3358Z" fill="currentColor" className="text-foreground"/>
            <path d="M187.991 40.0567V3.57861H193.202V40.0567H187.991Z" fill="currentColor" className="text-foreground"/>
            <path d="M161.154 35.1061H172.358C173.921 35.1061 175.224 34.585 176.266 33.5428C177.309 32.5005 177.83 31.1978 177.83 29.6344C177.83 28.0711 177.309 26.7683 176.266 25.726C175.224 24.6838 173.921 24.1627 172.358 24.1627H161.154V35.1061ZM161.154 8.52921V19.2121H170.951C172.48 19.2121 173.748 18.7083 174.755 17.7009C175.763 16.6934 176.266 15.4079 176.266 13.8446C176.266 12.316 175.763 11.0479 174.755 10.0405C173.748 9.03296 172.48 8.52921 170.951 8.52921H161.154ZM181.478 13.0629C181.478 16.6413 180.088 19.3163 177.309 21.0881C179.046 21.8524 180.435 23.0162 181.478 24.5796C182.52 26.2124 183.041 28.0711 183.041 30.1555C183.041 33.0043 182.103 35.3667 180.227 37.2427C178.351 39.1187 175.988 40.0567 173.14 40.0567H155.943V3.57861H171.993C174.738 3.57861 176.996 4.48188 178.768 6.28842C180.574 8.06021 181.478 10.3184 181.478 13.0629Z" fill="currentColor" className="text-foreground"/>
            <path d="M136.668 35.6269C139.204 35.6269 141.271 34.8279 142.869 33.2298C144.467 31.6317 145.266 29.5646 145.266 27.0285C145.266 24.4924 144.467 22.4253 142.869 20.8272C141.271 19.2291 139.204 18.4301 136.668 18.4301C134.132 18.4301 132.065 19.2291 130.467 20.8272C128.868 22.4253 128.069 24.4924 128.069 27.0285C128.069 29.5646 128.868 31.6317 130.467 33.2298C132.065 34.8279 134.132 35.6269 136.668 35.6269ZM122.858 14.0006H128.069V17.44C130.571 14.7997 133.697 13.4795 137.45 13.4795C141.167 13.4795 144.259 14.7649 146.725 17.3358C149.227 19.9413 150.477 23.1722 150.477 27.0285C150.477 30.8848 149.227 34.1157 146.725 36.7213C144.259 39.2921 141.167 40.5775 137.45 40.5775C133.697 40.5775 130.571 39.2574 128.069 36.617V50.4787H122.858V14.0006Z" fill="currentColor" className="text-foreground"/>
            <path d="M96.0786 33.2298C97.6767 34.8279 99.7438 35.6269 102.28 35.6269C104.816 35.6269 106.883 34.8279 108.481 33.2298C110.079 31.6317 110.878 29.5646 110.878 27.0285C110.878 24.4924 110.079 22.4253 108.481 20.8272C106.883 19.2291 104.816 18.4301 102.28 18.4301C99.7438 18.4301 97.6767 19.2291 96.0786 20.8272C94.4805 22.4253 93.6815 24.4924 93.6815 27.0285C93.6815 29.5646 94.4805 31.6317 96.0786 33.2298ZM110.878 14.0006H116.089V40.0564H110.878V36.617C108.377 39.2574 105.25 40.5775 101.498 40.5775C97.7809 40.5775 94.689 39.2921 92.2224 36.7213C89.721 34.1157 88.4703 30.8848 88.4703 27.0285C88.4703 23.1722 89.721 19.9413 92.2224 17.3358C94.689 14.7649 97.7809 13.4795 101.498 13.4795C105.25 13.4795 108.377 14.7997 110.878 17.44V14.0006Z" fill="currentColor" className="text-foreground"/>
            <path d="M63.7196 3.57861H90.8176V8.52921H79.8742V40.0567H74.663V8.52921H63.7196V3.57861Z" fill="currentColor" className="text-foreground"/>
          </svg>
        </div>
        
        {/* CTA Button - показывается только после скролла, позиционирован справа */}
        <div className={`absolute right-0 transition-all duration-500 ease-out ${
          showCTA 
            ? 'opacity-100 translate-y-0 scale-100' 
            : 'opacity-0 translate-y-2 scale-95 pointer-events-none'
        }`}>
          <Button 
            variant="glass-breath"
            size="touch"
            onClick={handleCTAClick}
            className={`slow-pulse transition-all duration-300 ${showCTA ? 'animate-fade-in' : ''}`}
            style={{
              backgroundColor: 'rgba(255,255,255,0.18)',
              animation: showCTA ? 'breath-glass 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' : 'none',
              willChange: 'transform, box-shadow, background-color',
            }}
            icon={
              <svg width="20" height="20" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-4 h-4 md:w-5 md:h-5">
                <rect width="52" height="52" rx="26" fill="#6155F5"/>
                <path d="M16.7363 26.0068C16.7363 26.516 16.7778 27.0168 16.8608 27.5093C16.9438 27.9963 17.0601 28.4666 17.2095 28.9204L15.7817 29.5181C15.5936 28.9647 15.4469 28.3947 15.3418 27.8081C15.2367 27.216 15.1841 26.6156 15.1841 26.0068C15.1841 25.3926 15.2339 24.7922 15.3335 24.2056C15.4386 23.6134 15.5853 23.0435 15.7734 22.4956L17.2095 23.0933C17.0545 23.547 16.9355 24.0174 16.8525 24.5044C16.7751 24.9914 16.7363 25.4922 16.7363 26.0068ZM21.833 17.7144C20.9421 18.1626 20.1424 18.7437 19.4341 19.4575C18.7257 20.1659 18.1502 20.9683 17.7075 21.8647L16.2964 21.2671C16.8221 20.1991 17.5111 19.2389 18.3633 18.3867C19.2155 17.5345 20.1756 16.8455 21.2437 16.3198L21.833 17.7144ZM25.9834 16.7432C25.4743 16.7432 24.9735 16.7847 24.481 16.8677C23.994 16.9451 23.5208 17.0614 23.0615 17.2163L22.4639 15.7969C23.0173 15.6032 23.59 15.4538 24.1821 15.3486C24.7743 15.2435 25.3747 15.1909 25.9834 15.1909C26.5977 15.1909 27.1981 15.2435 27.7847 15.3486C28.3768 15.4538 28.9468 15.6032 29.4946 15.7969L28.9136 17.2163C28.4543 17.0614 27.9784 16.9451 27.4858 16.8677C26.9989 16.7847 26.498 16.7432 25.9834 16.7432ZM34.2759 21.8564C33.8276 20.9544 33.2493 20.152 32.541 19.4492C31.8327 18.7409 31.0303 18.1626 30.1338 17.7144L30.7231 16.3032C31.7912 16.8345 32.7513 17.5262 33.6035 18.3784C34.4613 19.2306 35.1558 20.1935 35.687 21.2671L34.2759 21.8564ZM35.2554 26.0068C35.2554 25.4922 35.2139 24.9914 35.1309 24.5044C35.0534 24.0119 34.9399 23.5387 34.7905 23.085L36.2017 22.4873C36.3953 23.0407 36.5448 23.6134 36.6499 24.2056C36.755 24.7922 36.8076 25.3926 36.8076 26.0068C36.8076 26.6156 36.755 27.216 36.6499 27.8081C36.5448 28.4002 36.3953 28.973 36.2017 29.5264L34.7905 28.9287C34.9399 28.4749 35.0534 28.0018 35.1309 27.5093C35.2139 27.0168 35.2554 26.516 35.2554 26.0068ZM30.1338 34.291C31.0358 33.8483 31.841 33.2728 32.5493 32.5645C33.2576 31.8561 33.8359 31.0537 34.2842 30.1572L35.6787 30.7466C35.1585 31.8146 34.4696 32.7747 33.6118 33.627C32.7596 34.4792 31.7967 35.1709 30.7231 35.7021L30.1338 34.291ZM25.9917 35.2705C26.5008 35.2705 26.9989 35.229 27.4858 35.146C27.9728 35.0685 28.446 34.9551 28.9053 34.8057L29.5029 36.2251C28.9495 36.4132 28.3796 36.5571 27.793 36.6567C27.2064 36.7619 26.606 36.8145 25.9917 36.8145C25.383 36.8145 24.7826 36.7619 24.1904 36.6567C23.5983 36.5516 23.0256 36.4049 22.4722 36.2168L23.0615 34.7891C23.5208 34.9495 23.994 35.0685 24.481 35.146C24.9735 35.229 25.4771 35.2705 25.9917 35.2705ZM17.7158 30.1572C18.1585 31.0482 18.7313 31.8478 19.4341 32.5562C20.1424 33.2645 20.9421 33.84 21.833 34.2827L21.252 35.6938C20.1784 35.1681 19.2155 34.4792 18.3633 33.627C17.5166 32.7747 16.8276 31.8146 16.2964 30.7466L17.7158 30.1572Z" fill="white"/>
              </svg>
            }
          >
            <span className="hidden sm:inline">Получить индивидуальное КП</span>
            <span className="sm:hidden">Получить КП</span>
          </Button>
        </div>
        </div>
      </div>
    </header>
    </>
  );
};

export default Header;